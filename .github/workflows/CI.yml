name: CI

on:
  pull_request:
    paths: # PRì— CI íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆê±°ë‚˜, ì–´ë–¤ ë””ë ‰í† ë¦¬ê±´ swift í™•ì¥ì íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ê²½ìš° ì‹¤í–‰
      - ".github/workflows/CI.yml"
      - "**/**.swift"
  push:
    branches: [ develop, "epic/**", "story/**" ,"task/**" ]

env:
  CACHED_PACKAGE_DEPENDENCY_PATHS: ${{ github.workspace }}/.build

jobs:
  prepare-ci: # job ìƒì„±, ìºì‹œ ì„¤ì •
    name: ğŸš§ Prepare CI # job ì´ë¦„ ì„¤ì •
    runs-on: macos-14 # ê°€ìƒí™˜ê²½ ì„¤ì •

    steps: # steps í‚¤ë¥¼ í†µí•´ ìˆœì°¨ì ì¸ ìˆ˜í–‰í•  ì‘ì—… ëª…ì‹œ
      - uses: actions/checkout@v3 # ì›ê²© ì €ì¥ì†Œì—ì„œ CIì„œë²„ë¡œ ì½”ë“œ ë‚´ë ¤ë°›ê¸°

      - name: Select Xcode 16.0
        run: sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer

      # ì˜ì¡´ì„± ìºì‹± key ê³„ì‚°
      - name: Compute package dependency cache key
        id: compute_package_hash
        run: echo "package_hash=${{ hashFiles('Package.swift') }}" >> $GITHUB_OUTPUT
        # hashFiles(path):  ì¼ì¹˜í•˜ëŠ” hashSet ë°˜í™˜ ,ê·¸ ê°’ì„ outpusì— ë‹´ìŒ
        # steps.cache_package_dependencies.outputs.package_hash = hash ê°’

      # keyì— í•´ë‹¹í•˜ëŠ” ê°’ì´ pathì— ìˆì„ ê²½ìš°, ê·¸ íŒŒì¼ì„ ê°€ì ¸ì˜¤ê³  ì—†ë‹¤ë©´ keyì— í•´ë‹¹ pathë¥¼ ì €ì¥í•˜ì—¬ ìºì‹±
      - name: Check package dependency cache
        uses: actions/cache@v3
        id: cache_package_dependencies
        with: # cache@v3ì— ì‚¬ìš©í•  íŒŒë¼ë¯¸í„° ëª…ì‹œ
          path: ${{ env.CACHED_PACKAGE_DEPENDENCY_PATHS }}
          key: ${{ steps.compute_package_hash.outputs.package_hash }}
        # steps.cache_package_dependencies.outputs.cache-hit = cache-hit ì—¬ë¶€ ì €ì¥

      - name: Echo dependency cache hit
        run: echo "package cache hit = ${{ steps.cache_package_dependencies.outputs.cache-hit }}"

      - uses: jdx/mise-action@v2 # mise ì„¤ì¹˜

      - name: ğŸ›œ Install Tuist
        run: mise install tuist

      - name: ğŸ“¦ Install dependencies needs
        if: steps.cache_package_dependencies.outputs.cache-hit != 'true'
        run: make install

    outputs: # ë‹¤ë¥¸ jobì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ output ê°’ì„ job ìˆ˜ì¤€ìœ¼ë¡œ ëŒì–´ì˜¬ë¦¼
      package_dependency_cache_key: ${{ steps.compute_package_hash.outputs.package_hash }}
      # needs.[job name].outputs.ë³€ìˆ˜ëª…
      # needs.prepare-ci.outputs.package_dependency_cache_key

  test: # test job ìƒì„±
    name: ğŸ§ª Test
    runs-on: macos-14 # ê°€ìƒí™˜ê²½ ì„¤ì •
    needs: prepare-ci # ì„ í–‰ì‘ì—…

    steps: # steps í‚¤ë¥¼ í†µí•´ ìˆœì°¨ì ì¸ ìˆ˜í–‰í•  ì‘ì—… ëª…ì‹œ
      - uses: actions/checkout@v3 # ì›ê²© ì €ì¥ì†Œì—ì„œ CIì„œë²„ë¡œ ì½”ë“œ ë‚´ë ¤ë°›ê¸°

      - name: Select Xcode 16.0
        run: sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer

      - uses: jdx/mise-action@v2 

      - name: ğŸ›œ Install Tuist
        run: mise install tuist

      - name: Check package dependency cache
        uses: actions/cache@v3
        id: cache_package_dependencies
        with:
          path: ${{ env.CACHED_PACKAGE_DEPENDENCY_PATHS }}
          key: ${{ needs.prepare-ci.outputs.package_dependency_cache_key }}
        

      - name: ğŸ“¦ Install dependencies needs
        if: steps.cache_package_dependencies.outputs.cache-hit != 'true'
        run: make install

      - name: "ğŸ§ª Start Test"
        run:  make test